<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Voice2Action ‚Äì –ó–∞–≥—Ä—É–∑–∫–∞ –∞—É–¥–∏–æ</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    .upload-container {
      max-width: 800px;
      margin: 60px auto;
      padding: 40px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .upload-card {
      background: white;
      padding: 40px;
      border-radius: 15px;
    }
    
    .drop-zone {
      border: 3px dashed #667eea;
      border-radius: 15px;
      padding: 60px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: #f8f9ff;
    }
    
    .drop-zone:hover {
      border-color: #764ba2;
      background: #f0f2ff;
      transform: translateY(-2px);
    }
    
    .drop-zone.dragover {
      border-color: #00d4aa;
      background: #e6fff9;
    }
    
    .upload-icon {
      font-size: 64px;
      color: #667eea;
      margin-bottom: 20px;
    }
    
    .selection-section {
      margin: 30px 0;
      padding: 20px;
      background: #f8f9ff;
      border-radius: 10px;
    }
    
    .checkbox-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .checkbox-item {
      display: flex;
      align-items: center;
      padding: 12px;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      border: 2px solid transparent;
    }
    
    .checkbox-item:hover {
      border-color: #667eea;
      transform: translateX(5px);
    }
    
    .checkbox-item input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin-right: 10px;
      cursor: pointer;
    }
    
    .progress-container {
      margin: 30px 0;
      display: none;
    }
    
    .progress-bar {
      width: 100%;
      height: 30px;
      background: #e0e0e0;
      border-radius: 15px;
      overflow: hidden;
      position: relative;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      width: 0%;
      transition: width 0.5s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }
    
    .progress-text {
      text-align: center;
      margin-top: 10px;
      color: #666;
    }
    
    .results-container {
      margin-top: 30px;
      display: none;
    }
    
    .result-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 15px;
      border-left: 4px solid #667eea;
    }
    
    .download-btn {
      display: inline-block;
      padding: 10px 20px;
      background: #667eea;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      margin: 5px;
      transition: all 0.3s;
    }
    
    .download-btn:hover {
      background: #764ba2;
      transform: translateY(-2px);
    }
  </style>
</head>
<body>
  <header>
    <div class="container header">
      <span class="logo-text">Voice2<span class="ai-accent">Action</span></span>
      <nav>
        <a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a>
        <a href="features.html">–§—É–Ω–∫—Ü–∏–∏</a>
        <a href="app.html" class="active">–ó–∞–≥—Ä—É–∑–∏—Ç—å</a>
        <a href="pricing.html">–¢–∞—Ä–∏—Ñ—ã</a>
      </nav>
    </div>
  </header>

  <div class="upload-container">
    <div class="upload-card">
      <h1 style="text-align: center; color: #667eea; margin-bottom: 30px;">
        üéôÔ∏è –ó–∞–≥—Ä—É–∑–∏ –∞—É–¥–∏–æ –≤—Å—Ç—Ä–µ—á–∏
      </h1>
      
      <!-- Drop Zone -->
      <div class="drop-zone" id="dropZone">
        <div class="upload-icon">üìÅ</div>
        <h3>–ü–µ—Ä–µ—Ç–∞—â–∏ –∞—É–¥–∏–æ—Ñ–∞–π–ª —Å—é–¥–∞</h3>
        <p>–∏–ª–∏</p>
        <button class="btn primary-btn" onclick="document.getElementById('fileInput').click()">
          –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
        </button>
        <input type="file" id="fileInput" accept="audio/*" hidden>
        <p style="margin-top: 20px; color: #999; font-size: 14px;">
          –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: MP3, OGG, WAV, M4A (–¥–æ 20 –ú–ë)
        </p>
      </div>
      
      <!-- –í—ã–±–æ—Ä —Ç–∏–ø–∞ –∞–Ω–∞–ª–∏–∑–∞ -->
      <div class="selection-section" id="analysisSection" style="display:none;">
        <h3>üìä –¢–∏–ø –∞–Ω–∞–ª–∏–∑–∞:</h3>
        <div class="checkbox-group">
          <label class="checkbox-item">
            <input type="radio" name="analysis" value="meeting" checked>
            <span>üìã –í—Å—Ç—Ä–µ—á–∞</span>
          </label>
          <label class="checkbox-item">
            <input type="radio" name="analysis" value="sales">
            <span>üíº –ü—Ä–æ–¥–∞–∂–∏</span>
          </label>
          <label class="checkbox-item">
            <input type="radio" name="analysis" value="interview">
            <span>üë§ –ò–Ω—Ç–µ—Ä–≤—å—é</span>
          </label>
          <label class="checkbox-item">
            <input type="radio" name="analysis" value="custom">
            <span>‚úèÔ∏è –ö–∞—Å—Ç–æ–º</span>
          </label>
        </div>
      </div>
      
      <!-- –í—ã–±–æ—Ä —ç–∫—Å–ø–æ—Ä—Ç–∞ -->
      <div class="selection-section" id="exportSection" style="display:none;">
        <h3>üì§ –§–æ—Ä–º–∞—Ç—ã —ç–∫—Å–ø–æ—Ä—Ç–∞:</h3>
        <div class="checkbox-group">
          <label class="checkbox-item">
            <input type="checkbox" name="export" value="excel">
            <span>üìä Excel</span>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" name="export" value="word">
            <span>üìÑ Word</span>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" name="export" value="jira">
            <span>üé´ Jira</span>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" name="export" value="google_docs">
            <span>üìù Google Docs</span>
          </label>
        </div>
        
        <button class="btn primary-btn" id="startBtn" style="margin-top: 20px; width: 100%;">
          ‚úÖ –ù–∞—á–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É
        </button>
      </div>
      
      <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å -->
      <div class="progress-container" id="progressContainer">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill">0%</div>
        </div>
        <p class="progress-text" id="progressText">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
      </div>
      
      <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
      <div class="results-container" id="resultsContainer">
        <h2 style="color: #00d4aa;">‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h2>
        
        <div class="result-card" id="summaryCard">
          <h3>üìã Summary</h3>
          <p id="summaryText"></p>
        </div>
        
        <div class="result-card" id="tasksCard">
          <h3>‚úÖ –ó–∞–¥–∞—á–∏</h3>
          <ul id="tasksList"></ul>
        </div>
        
        <div class="result-card" id="exportsCard">
          <h3>üì• –°–∫–∞—á–∞—Ç—å</h3>
          <div id="downloadLinks"></div>
        </div>
        
        <button class="btn secondary" onclick="resetForm()">
          üîÑ –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –µ—â—ë –æ–¥–∏–Ω —Ñ–∞–π–ª
        </button>
      </div>
    </div>
  </div>

  <script>
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const analysisSection = document.getElementById('analysisSection');
    const exportSection = document.getElementById('exportSection');
    const startBtn = document.getElementById('startBtn');
    const progressContainer = document.getElementById('progressContainer');
    const resultsContainer = document.getElementById('resultsContainer');
    
    let selectedFile = null;
    
    // Drag & Drop
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });
    
    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });
    
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      
      const file = e.dataTransfer.files[0];
      handleFileSelect(file);
    });
    
    // File Input
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      handleFileSelect(file);
    });
    
    function handleFileSelect(file) {
      if (!file) return;
      
      // –í–∞–ª–∏–¥–∞—Ü–∏—è
      const validTypes = ['audio/mpeg', 'audio/ogg', 'audio/wav', 'audio/mp4', 'audio/x-m4a'];
      if (!validTypes.includes(file.type)) {
        alert('–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç. –ò—Å–ø–æ–ª—å–∑—É–π MP3, OGG, WAV –∏–ª–∏ M4A.');
        return;
      }
      
      if (file.size > 20 * 1024 * 1024) {
        alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º—É–º 20 –ú–ë.');
        return;
      }
      
      selectedFile = file;
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–ø—Ü–∏–∏
      dropZone.innerHTML = `
        <div class="upload-icon">‚úÖ</div>
        <h3>${file.name}</h3>
        <p>${(file.size / 1024 / 1024).toFixed(2)} –ú–ë</p>
        <button class="btn secondary" onclick="resetFileSelection()">–í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π</button>
      `;
      
      analysisSection.style.display = 'block';
      exportSection.style.display = 'block';
    }
    
    function resetFileSelection() {
      selectedFile = null;
      fileInput.value = '';
      dropZone.innerHTML = `
        <div class="upload-icon">üìÅ</div>
        <h3>–ü–µ—Ä–µ—Ç–∞—â–∏ –∞—É–¥–∏–æ—Ñ–∞–π–ª —Å—é–¥–∞</h3>
        <p>–∏–ª–∏</p>
        <button class="btn primary-btn" onclick="document.getElementById('fileInput').click()">
          –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
        </button>
        <p style="margin-top: 20px; color: #999; font-size: 14px;">
          –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: MP3, OGG, WAV, M4A (–¥–æ 20 –ú–ë)
        </p>
      `;
      analysisSection.style.display = 'none';
      exportSection.style.display = 'none';
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞
    startBtn.addEventListener('click', async () => {
      if (!selectedFile) {
        alert('–í—ã–±–µ—Ä–∏ —Ñ–∞–π–ª!');
        return;
      }
      
      const analysisType = document.querySelector('input[name="analysis"]:checked').value;
      const exports = Array.from(document.querySelectorAll('input[name="export"]:checked'))
        .map(cb => cb.value);
      
      if (exports.length === 0) {
        alert('–í—ã–±–µ—Ä–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ñ–æ—Ä–º–∞—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞!');
        return;
      }
      
      // –°–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—ã, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
      analysisSection.style.display = 'none';
      exportSection.style.display = 'none';
      progressContainer.style.display = 'block';
      
      try {
        // –®–∞–≥ 1: –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
        updateProgress(10, '–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞...');
        
        const formData = new FormData();
        formData.append('audio', selectedFile);
        
        const uploadResponse = await fetch('http://localhost:8000/api/process-audio', {
          method: 'POST',
          body: formData
        });
        
        if (!uploadResponse.ok) {
          throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
        }
        
        const { job_id } = await uploadResponse.json();
        
        // –®–∞–≥ 2: Polling —Å—Ç–∞—Ç—É—Å–∞
        await pollStatus(job_id);
        
        // –®–∞–≥ 3: –≠–∫—Å–ø–æ—Ä—Ç
        updateProgress(90, '–°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤...');
        
        const exportResponse = await fetch('http://localhost:8000/api/export', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ job_id, exports })
        });
        
        if (!exportResponse.ok) {
          throw new Error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞');
        }
        
        const exportData = await exportResponse.json();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        displayResults(exportData);
        
      } catch (error) {
        alert('–û—à–∏–±–∫–∞: ' + error.message);
        resetForm();
      }
    });
    
    async function pollStatus(jobId) {
      const pollInterval = setInterval(async () => {
        const response = await fetch(`http://localhost:8000/api/status/${jobId}`);
        const data = await response.json();
        
        updateProgress(data.progress, data.status);
        
        if (data.complete) {
          clearInterval(pollInterval);
          
          if (data.error) {
            throw new Error(data.error);
          }
          
          return data.results;
        }
      }, 2000);
      
      // –ñ–¥—ë–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
      return new Promise((resolve, reject) => {
        const checkComplete = setInterval(async () => {
          const response = await fetch(`http://localhost:8000/api/status/${jobId}`);
          const data = await response.json();
          
          if (data.complete) {
            clearInterval(checkComplete);
            if (data.error) {
              reject(new Error(data.error));
            } else {
              resolve(data.results);
            }
          }
        }, 2000);
      });
    }
    
    function updateProgress(percent, text) {
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');
      
      progressFill.style.width = percent + '%';
      progressFill.textContent = percent + '%';
      progressText.textContent = text;
    }
    
    function displayResults(data) {
      progressContainer.style.display = 'none';
      resultsContainer.style.display = 'block';
      
      // Summary
      document.getElementById('summaryText').textContent = 
        data.exports.summary || '–†–µ–∑—é–º–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ';
      
      // –ó–∞–¥–∞—á–∏
      const tasksList = document.getElementById('tasksList');
      tasksList.innerHTML = '';
      
      if (data.exports.tasks && data.exports.tasks.length > 0) {
        data.exports.tasks.forEach(task => {
          const li = document.createElement('li');
          li.innerHTML = `<strong>${task.description}</strong><br>
            üìÖ ${task.deadline} | üë§ ${task.assignee}`;
          tasksList.appendChild(li);
        });
      }
      
      // –°—Å—ã–ª–∫–∏ –Ω–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
      const downloadLinks = document.getElementById('downloadLinks');
      downloadLinks.innerHTML = '';
      
      Object.entries(data.exports).forEach(([type, info]) => {
        if (type === 'excel' || type === 'word') {
          const link = document.createElement('a');
          link.href = `http://localhost:8000${info.download_url}`;
          link.className = 'download-btn';
          link.textContent = `üì• –°–∫–∞—á–∞—Ç—å ${type.toUpperCase()}`;
          downloadLinks.appendChild(link);
        } else if (type === 'jira' && info.issues) {
          info.issues.forEach(issue => {
            const link = document.createElement('a');
            link.href = issue.url;
            link.target = '_blank';
            link.className = 'download-btn';
            link.textContent = `üé´ ${issue.key}`;
            downloadLinks.appendChild(link);
          });
        } else if (type === 'google_docs' && info.doc_url) {
          const link = document.createElement('a');
          link.href = info.doc_url;
          link.target = '_blank';
          link.className = 'download-btn';
          link.textContent = 'üìù Google Doc';
          downloadLinks.appendChild(link);
        }
      });
    }
    
    function resetForm() {
      progressContainer.style.display = 'none';
      resultsContainer.style.display = 'none';
      resetFileSelection();
    }
  </script>
</body>
</html>
